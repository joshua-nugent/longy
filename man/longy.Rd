% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/longy.R
\name{longy}
\alias{longy}
\title{High-Level Wrapper for Longitudinal Causal Inference}
\usage{
longy(
  data,
  id,
  time,
  outcome,
  treatment,
  censoring = NULL,
  observation = NULL,
  baseline = character(0),
  timevarying = character(0),
  sampling_weights = NULL,
  outcome_type = "binary",
  competing = NULL,
  regimes = list(always = 1L, never = 0L),
  estimator = "ipw",
  covariates = NULL,
  learners = c("SL.glm", "SL.mean"),
  stabilized = TRUE,
  truncation = NULL,
  truncation_quantile = NULL,
  inference = "ic",
  ci_level = 0.95,
  n_boot = 200L,
  cluster = NULL,
  times = NULL,
  adaptive_cv = TRUE,
  min_obs = 50L,
  min_events = 20L,
  bounds = c(0.005, 0.995),
  risk_set_treatment = "all",
  risk_set_outcome = "all",
  g_bounds = c(0.01, 1),
  outcome_range = NULL,
  cross_fit = NULL,
  cross_fit_seed = NULL,
  sl_fn = "ffSL",
  k = Inf,
  verbose = TRUE
)
}
\arguments{
\item{data}{A data.frame or data.table in long format.}

\item{id}{Character. Subject identifier column.}

\item{time}{Character. Time index column.}

\item{outcome}{Character. Outcome column.}

\item{treatment}{Character. Binary treatment column.}

\item{censoring}{Character (length 1). Column name for a character/factor
censoring status column. Must contain \code{"uncensored"} for non-censored
rows; other values (e.g. \code{"censored"}, \code{"death"}, \code{"ltfu"})
are treated as distinct censoring causes, each modeled separately. See
\code{\link{longy_data}} for full details. NULL if no censoring.}

\item{observation}{Character. Intermittent observation column. NULL to
auto-detect from NA values in the outcome column (see
\code{\link{longy_data}}).}

\item{baseline}{Character vector. Baseline covariate columns.}

\item{timevarying}{Character vector. Time-varying covariate columns.}

\item{sampling_weights}{Character. Column name for external sampling/survey
weights. See \code{\link[=longy_data]{longy_data()}} for details. NULL if none.}

\item{outcome_type}{Character. \code{"binary"}, \code{"continuous"}, or \code{"survival"}.}

\item{competing}{Character. Column name for a binary absorbing competing
event indicator. Used with \code{outcome_type = "survival"} to estimate
cause-specific cumulative incidence. See \code{\link[=longy_data]{longy_data()}} for details. NULL
if no competing risks.}

\item{regimes}{Named list. Each element defines a regime:
\itemize{
\item For static: an integer (0 or 1), e.g., \code{list(always = 1L, never = 0L)}
\item For dynamic: a function returning 0/1
\item For stochastic: a function returning P(A=1)
}}

\item{estimator}{Character vector. Which estimator(s) to run. Any combination
of \code{"ipw"}, \code{"gcomp"}, and \code{"tmle"} (e.g.
\code{c("ipw", "tmle")}). Results are keyed as
\code{{regime}_{estimator}}. Nuisance models are shared across estimators
to avoid redundant fitting.}

\item{covariates}{Character vector. Predictor columns for nuisance models.
If NULL, uses all baseline + timevarying.}

\item{learners}{Character vector or named list. SuperLearner library names
(default \code{c("SL.glm", "SL.mean")}). Set to NULL to use plain glm
without SuperLearner. When a named list, valid keys are \code{treatment},
\code{censoring}, \code{observation}, \code{outcome}, and \code{default}.
Missing keys fall back to \code{default}, which itself falls back to
\code{c("SL.glm", "SL.mean")}. Example:
\code{list(default = c("SL.glm", "SL.gam"), outcome = c("SL.glm", "SL.gam", "SL.earth"))}.}

\item{stabilized}{Logical. Use stabilized weights (IPW only).}

\item{truncation}{Numeric. Weight truncation cap (IPW only).}

\item{truncation_quantile}{Numeric. Quantile-based weight truncation (IPW only).}

\item{inference}{Character. \code{"ic"}, \code{"bootstrap"}, or \code{"sandwich"}.
Ignored for G-comp (always bootstrap).}

\item{ci_level}{Numeric. Confidence level.}

\item{n_boot}{Integer. Bootstrap replicates.}

\item{cluster}{Character. Cluster column for robust SEs (IPW only).}

\item{times}{Numeric vector. Time points for estimation. NULL = all.}

\item{adaptive_cv}{Logical. Adaptive CV fold selection.}

\item{min_obs}{Integer. Minimum observations for model fitting.}

\item{min_events}{Integer. Minimum minority-class events required to fit a
model. When the minority class count is below this AND the minority rate
is below 0.01, marginal fallback is used. Default 20.}

\item{bounds}{Numeric(2). Prediction probability bounds.}

\item{risk_set_treatment}{Character. Which subjects form the risk set for
treatment model fitting. \code{"all"} (default) uses all uncensored
subjects (fit once, share across regimes). \code{"followers"} restricts to
regime-followers at each time, fitting separate models per regime.}

\item{risk_set_outcome}{Character. Which subjects form the training set for
outcome models (used by G-comp and TMLE). \code{"all"} (default) uses all
uncensored subjects. \code{"followers"} restricts to regime-followers, so
the model learns \code{E(Q|H)} without extrapolation to non-followers.}

\item{g_bounds}{Numeric(2). Bounds for cumulative g (denominator of clever
covariate). Default \code{c(0.01, 1)}. Used by TMLE and IPW.}

\item{outcome_range}{Numeric(2) or NULL. Range for scaling continuous
outcomes to \code{[0,1]} in TMLE. If NULL, uses empirical range.
Ignored for binary/survival outcomes.}

\item{cross_fit}{Integer or NULL. Number of cross-fitting folds. When
non-NULL, nuisance models (g_A, g_C, g_R) are fit on training folds and
predicted on validation folds, and TMLE uses cross-fitted Q models.
This eliminates overfitting bias in EIF-based inference. Typical values
are 5 or 10. Default NULL (no cross-fitting).}

\item{cross_fit_seed}{Integer or NULL. Random seed for cross-fitting fold
assignment. NULL for no seed.}

\item{sl_fn}{Character. Which SuperLearner implementation to use:
\code{"SuperLearner"} (default, sequential CV) or \code{"ffSL"}
(future-factorial, parallelizes fold x algorithm combinations via
\code{future.apply}).}

\item{k}{Integer or \code{Inf}. Number of lagged time steps of covariate
history to include as additional predictors. See \code{\link{longy_data}}
for details. Default \code{Inf} (all available history).}

\item{verbose}{Logical. Print progress.}
}
\value{
An S3 object of class \code{"longy_data"} with estimation results
accumulated in \code{obj$results} (a named list of \code{longy_result}
objects keyed as \code{{regime}_{estimator}}). Use \code{results(obj)} to
access results, or \code{obj$results$always_ipw$estimates} directly.
}
\description{
Runs the entire longy pipeline in one call: data setup, regime definition,
nuisance model fitting, and estimation via IPW, G-computation, or both.
}
\examples{
\dontrun{
obj <- longy(
  data = sim_longy,
  id = "id", time = "time", outcome = "Y",
  treatment = "A", censoring = "C", observation = "R",
  baseline = c("W1", "W2"), timevarying = c("L1", "L2"),
  regimes = list(always = 1L, never = 0L)
)
obj$results$always_ipw$estimates
results(obj, estimator = "ipw")
}

}
