# longy Development Log

## v0.1 — Completed 2026-02-12

### What was built

Full R package implementing IPW estimation for longitudinal causal inference. The package is installed at `longy/` and pushed to `github.com/joshua-nugent/longy` (private).

### Package contents

**14 R source files:**

| File | What it does |
|------|-------------|
| `R/longy.R` | `longy()` high-level wrapper — runs full pipeline in one call |
| `R/data_input.R` | `longy_data()` constructor, validation, `set_crossfit()`, print/summary |
| `R/regimes.R` | `define_regime()` for static/dynamic/stochastic regimes |
| `R/fit_treatment.R` | `fit_treatment()` — g_A propensity score models |
| `R/fit_censoring.R` | `fit_censoring()` — g_C censoring models (absorbing, cumulated) |
| `R/fit_observation.R` | `fit_observation()` — g_R observation models (intermittent, NOT cumulated) |
| `R/weights.R` | `compute_weights()` — combines all nuisance models into final IPW weights |
| `R/estimate_ipw.R` | `estimate_ipw()` — Hajek estimator, print/summary/plot methods |
| `R/inference.R` | IC-based, bootstrap, and sandwich (survey pkg) inference |
| `R/diagnostics.R` | `weight_diagnostics()`, `positivity_diagnostics()` |
| `R/crossfit.R` | Stub — architecture ready, implementation deferred to v0.3 |
| `R/utils.R` | `.bound()`, `.safe_sl()`, `.adaptive_cv_folds()`, `.ess()`, etc. |
| `R/longy-package.R` | Package-level docs, sim_longy dataset docs, globalVariables |
| `R/zzz.R` | .onLoad |

**Simulated dataset:** `data/sim_longy.rda` — 500 subjects, 10 time points, with known true causal effects stored as attribute `"true_effects"`. Generated by `data-raw/make_sim_longy.R`.

**Tests:** 103 tests across 10 test files in `tests/testthat/`, plus `helper-simulate.R` with 4 data generators (`simulate_test_data`, `simulate_no_confounding`, `simulate_no_censoring`, `simulate_always_observed`).

**Docs:** All exported functions have roxygen2 documentation. 15 `.Rd` files in `man/`.

### Key design decisions

- **S3 classes** (not R6) for `longy_data`, `longy_result`, `longy_results`
- **data.table** internally via `@import data.table`; accepts data.frame at boundary
- **SuperLearner** optional (in Suggests); falls back to glm via `.safe_sl()`
- **Long format only** — one row per person-time
- **Three nuisance models** matching `ipw run.R`:
  - g_A: treatment propensity (risk set: consistent + uncensored through t-1)
  - g_C: censoring (risk set: above + treatment at t consistent with regime)
  - g_R: observation (risk set: above + uncensored at t — most restrictive)
- **Weight formula**: `final(t) = cumprod(sw_a * sw_c)[t] * sw_r(t)` — A×C cumulated, R point-in-time
- **Pipe-friendly**: each step returns modified `longy_data` object

### Verification results

- `devtools::check()`: **0 errors, 0 warnings**, 1 note (system time — not ours)
- `devtools::test()`: **103/103 pass**
- End-to-end on `sim_longy`: runs both regimes, early time points track known truth

### Issues encountered and resolved

1. **data.table cedta() error in R CMD check**: Fixed by using `@import data.table` instead of individual `@importFrom`, and replacing `.()` with `list()` in data.table `[` calls.
2. **Non-ASCII characters**: Em-dashes in `estimate_ipw.R` caused WARNING. Replaced with `--`.
3. **Marginal fallback not bounded**: When all outcomes at a time point are the same value, the marginal mean (0 or 1) exceeded prediction bounds. Fixed by applying `.bound()` to marginal fallback too.
4. **IC SE = 0 when all outcomes identical**: Legitimate edge case. Test updated to allow SE=0 when estimate is 0 or 1.

### Reference materials

- `ipw run.R` — the working IPW script this package is based on (in parent dir)
- `ltmle-master/` — ltmle package source (in parent dir)
- `stremr-master/` — stremr package source (in parent dir)
- `ffSL.R` — parallel SuperLearner wrapper used by ipw run.R (in parent dir)

---

## Next steps

### Short-term improvements to v0.1

1. **Larger simulated dataset or repeat with bigger n**: The current `sim_longy` (n=500) has heavy attrition at later time points. Consider regenerating with n=2000 or reducing confounding strength so more subjects remain in the risk set through time 9.

2. **SuperLearner integration testing**: Current tests only exercise glm fallback. Add tests that explicitly use `learners = c("SL.glm", "SL.mean")` to verify SuperLearner path works (requires SuperLearner installed).

3. **Sandwich inference testing**: Add explicit test for `inference = "sandwich"` (requires survey package). Currently only tested implicitly.

4. **Continuous outcome support**: `outcome_type = "continuous"` is accepted but the Hajek estimator and inference assume binary. Need to verify/adjust for continuous Y.

5. **Survival outcome support**: `outcome_type = "survival"` validates monotonicity but the estimator doesn't implement survival-specific logic (e.g., cumulative incidence).

6. **Better error messages**: Some edge cases (e.g., 0 subjects in risk set at a time point) could give more informative warnings.

### v0.2 — G-computation

- Implement outcome regression: fit E[Y | A, L, W] sequentially
- Sequential regression / iterated conditional expectations
- New files: `R/fit_outcome.R`, `R/estimate_gcomp.R`
- The `longy_data` object already has slots for this

### v0.3 — TMLE + cross-fitting

- Doubly-robust TMLE combining IPW + G-comp
- Activate cross-fitting in `crossfit.R` — sample-split nuisance estimation
- `set_crossfit()` already assigns folds; need to loop fits over folds
- New file: `R/estimate_tmle.R`

### v0.4+ — Extensions

- Stochastic interventions (regime infrastructure already supports this)
- Continuous treatments
- Competing risks
- Marginal structural models (smoothing across time)
- Parallel computation for bootstrap and SuperLearner (consider future/furrr)
- ffSL-style parallel SuperLearner (port from user's `ffSL.R`)

### Code quality

- Add `pkgdown` site
- Add CI via GitHub Actions (`R-CMD-check.yaml`)
- Consider `lintr` / `styler` for consistent formatting
- Vignette: "Getting started with longy"
